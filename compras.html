<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
<title>Comprar - Água Pura Premium</title>

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;800&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>
  const SUPABASE_URL = "https://ttqetzagmjsjiibchsqo.supabase.co";
  const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR0cWV0emFnbWpzamlpYmNoc3FvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE1MjEwNTEsImV4cCI6MjA4NzA5NzA1MX0.gwxFQHWMMeSpniFlPUKiQCx4UDWitKwx6bM22VcYArk";

  let supabase;
  let supabaseConectado = false;

  document.addEventListener('DOMContentLoaded', function() {
    try {
      supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
      supabaseConectado = true;
      console.log('Supabase OK');
    } catch (error) {
      console.error('Erro Supabase:', error);
      alert('Erro ao conectar com o banco de dados');
    }
  });

  function gerarCodigoPedido() {
    return Math.floor(1000000 + Math.random() * 9000000).toString();
  }

  async function finalizarCompra(tipoPagamento, valorFinal) {
    if (!supabaseConectado || !supabase) {
      alert('Erro: Supabase não conectado');
      return false;
    }

    const codigo = window.orderId || gerarCodigoPedido();
    const qty = parseInt(document.getElementById('qty')?.value || 1, 10);

    const pedido = {
      codigo_pedido: codigo,
      produto: "Galão Água Pura Premium 20L",
      quantidade: qty,
      valor_total: parseFloat(valorFinal.toFixed(2)),
      forma_pagamento: tipoPagamento,
      status: 'pendente',
      criado_em: new Date().toISOString(),
      atualizado_em: new Date().toISOString()
    };

    try {
      mostrarLoading();
      const { data, error } = await supabase.from('pedidos').insert([pedido]).select();
      esconderLoading();

      if (error) {
        alert('Erro ao salvar: ' + error.message);
        return false;
      }

      mostrarConfirmacao(codigo, tipoPagamento, valorFinal, qty);
      return true;
    } catch (err) {
      esconderLoading();
      alert('Erro: ' + err.message);
      return false;
    }
  }

  function mostrarLoading() {
    const div = document.createElement('div');
    div.id = 'loading';
    div.innerHTML = '<div class="spinner"></div><p>Salvando pedido...</p>';
    document.body.appendChild(div);
  }

  function esconderLoading() {
    const el = document.getElementById('loading');
    if (el) el.remove();
  }

  function mostrarConfirmacao(codigo, pagamento, valor, qtd) {
    const tipos = { 'pix': 'PIX', 'debito': 'Débito', 'credito': 'Crédito' };
    const div = document.createElement('div');
    div.className = 'modal-confirm';
    div.innerHTML = `
      <div class="modal-content">
        <div class="check">✓</div>
        <h2>Pedido Confirmado!</h2>
        <div class="codigo">${codigo}</div>
        <div class="info">
          <p><span>Produto:</span> <span>Galão 20L</span></p>
          <p><span>Qtd:</span> <span>${qtd}</span></p>
          <p><span>Pagamento:</span> <span>${tipos[pagamento]}</span></p>
          <p><span>Total:</span> <span>R$ ${valor.toFixed(2).replace('.', ',')}</span></p>
          <p><span>Status:</span> <span style="color:#f39c12">⏳ Pendente</span></p>
        </div>
        <p class="aviso">Pedido salvo no Supabase!</p>
        <button onclick="this.closest('.modal-confirm').remove(); fecharSheet();">OK</button>
      </div>
    `;
    document.body.appendChild(div);
  }
</script>

<style>
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body {
    font-family: 'Poppins', -apple-system, sans-serif;
    background: linear-gradient(135deg, #0b2a3a, #062033);
    color: #fff;
    min-height: 100vh;
    padding: 12px;
  }

  .wrap {
    max-width: 980px;
    margin: 0 auto;
    background: rgba(255,255,255,0.03);
    border-radius: 14px;
    padding: 20px;
  }

  .grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 28px;
  }

  @media (max-width: 900px) {
    .grid { grid-template-columns: 1fr; }
  }

  .left {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 18px;
  }

  .title {
    font-size: 20px;
    font-weight: 800;
    color: #e8fbff;
    text-align: center;
  }

  .product-photo {
    width: 100%;
    max-width: 420px;
    background: rgba(255,255,255,0.03);
    border-radius: 12px;
    padding: 18px;
    display: flex;
    justify-content: center;
    align-items: center;
  }

  .product-photo img {
    width: 280px;
    max-width: 86%;
    height: auto;
    filter: drop-shadow(0 30px 60px rgba(0,0,0,0.6));
    animation: float 5s ease-in-out infinite;
  }

  @keyframes float {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-18px); }
  }

  .stars { color: #ffd166; font-weight: 700; text-align: center; }
  .reviews { font-size: 13px; color: #cfeff6; text-align: center; }

  .right { display: flex; flex-direction: column; gap: 12px; }

  .price-row {
    display: flex;
    align-items: center;
    gap: 14px;
    margin: 8px 0;
  }

  .price {
    font-size: 32px;
    font-weight: 900;
    color: #00e0ff;
  }

  .shipping {
    font-size: 14px;
    color: #7ef5c7;
  }

  .payments {
    font-size: 14px;
    color: #dff9ff;
    margin-top: 12px;
    line-height: 1.5;
  }

  .cart-actions {
    margin-top: 20px;
    display: flex;
    gap: 12px;
    align-items: center;
    flex-wrap: wrap;
  }

  .qty { display: flex; align-items: center; gap: 8px; }

  .qty input {
    width: 72px;
    padding: 12px;
    border-radius: 10px;
    border: none;
    text-align: center;
    font-weight: 700;
    font-size: 16px;
    background: rgba(255,255,255,0.08);
    color: #fff;
  }

  .btn-select {
    padding: 12px 18px;
    border-radius: 12px;
    background: #007aff;
    color: #fff;
    border: none;
    font-weight: 700;
    font-size: 15px;
    cursor: pointer;
  }

  .btn-pay {
    flex: 1;
    padding: 14px 16px;
    border-radius: 12px;
    background: #6b7280;
    color: #fff;
    border: none;
    font-weight: 800;
    font-size: 16px;
    cursor: not-allowed;
    width: 100%;
    margin-top: 10px;
  }

  .btn-pay.active {
    background: #00b894;
    cursor: pointer;
  }

  #orderSummary {
    margin-top: 15px;
    display: none;
    background: rgba(255,255,255,0.05);
    padding: 15px;
    border-radius: 10px;
    text-align: center;
  }

  #orderSummary .label { font-size: 13px; color: #cfeff6; }
  #orderSummary .total { font-size: 22px; font-weight: 800; color: #00e0ff; }
  #orderSummary .code { font-size: 13px; color: #aef0ff; margin-top: 5px; }

  .details {
    margin-top: 22px;
    background: rgba(255,255,255,0.02);
    padding: 18px;
    border-radius: 12px;
  }

  .details h3 {
    margin: 0 0 10px 0;
    color: #aef0ff;
    font-size: 16px;
  }

  .details p { color: #dff9ff; font-size: 14px; line-height: 1.6; margin: 0 0 10px 0; }
  .specs p { color: #e6fbff; font-size: 14px; margin: 6px 0; }

  .overlay {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.7);
    z-index: 60;
    justify-content: center;
    align-items: flex-end;
  }

  .sheet {
    width: 100%;
    max-width: 440px;
    background: linear-gradient(180deg, #04232f, #01303a);
    color: #fff;
    border-radius: 20px 20px 0 0;
    padding: 20px;
    max-height: 90vh;
    overflow-y: auto;
  }

  .sheet h4 { margin: 0 0 14px 0; font-size: 18px; text-align: center; }

  .pay-option {
    background: rgba(255,255,255,0.05);
    padding: 16px;
    border-radius: 12px;
    margin-bottom: 10px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    cursor: pointer;
    border: 1px solid rgba(255,255,255,0.05);
  }

  .pay-option .label { font-weight: 700; color: #eaffff; font-size: 15px; }
  .pay-detail { font-size: 13px; color: #cfeff6; }

  .pix-box {
    margin-top: 12px;
    background: linear-gradient(180deg, #eafcff, #dff8ff);
    color: #03323a;
    padding: 20px;
    border-radius: 12px;
    text-align: center;
  }

  .pix-box .valor { font-size: 24px; font-weight: 800; margin: 8px 0; }
  .pix-box .chave {
    font-size: 18px;
    font-weight: 700;
    background: rgba(0,0,0,0.1);
    padding: 12px;
    border-radius: 8px;
    margin: 12px 0;
  }

  .pix-btns {
    display: flex;
    gap: 10px;
    margin-top: 15px;
  }

  .pix-btns button {
    flex: 1;
    padding: 12px;
    border-radius: 8px;
    border: none;
    font-weight: 700;
    font-size: 14px;
    cursor: pointer;
  }

  .btn-copiar { background: #007aff; color: #fff; }
  .btn-confirmar { background: #00b894; color: #fff; }

  .card-form input {
    width: 100%;
    padding: 14px;
    margin-top: 10px;
    border-radius: 10px;
    border: none;
    background: rgba(255,255,255,0.08);
    color: #fff;
    font-size: 15px;
  }

  .card-form input::placeholder { color: rgba(255,255,255,0.5); }

  .card-row { display: flex; gap: 10px; }
  .card-row input:first-child { flex: 1; }
  .card-row input:last-child { width: 100px; }

  .btn-confirmar-pagamento {
    width: 100%;
    padding: 14px;
    margin-top: 15px;
    border-radius: 10px;
    border: none;
    background: #007aff;
    color: #fff;
    font-weight: 700;
    font-size: 16px;
    cursor: pointer;
  }

  .btn-cancelar {
    width: 100%;
    padding: 12px;
    margin-top: 10px;
    border-radius: 10px;
    border: none;
    background: transparent;
    color: #aef0ff;
    font-size: 15px;
    cursor: pointer;
  }

  #loading {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.8);
    z-index: 999;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
  }

  .spinner {
    width: 50px;
    height: 50px;
    border: 4px solid rgba(255,255,255,0.2);
    border-top-color: #00b894;
    border-radius: 50%;
    animation: spin 1s linear infinite;
  }

  @keyframes spin { to { transform: rotate(360deg); } }

  #loading p { color: #fff; margin-top: 16px; font-size: 14px; }

  .modal-confirm {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.85);
    z-index: 100;
    display: flex;
    justify-content: center;
    align-items: center;
    padding: 20px;
  }

  .modal-content {
    background: linear-gradient(180deg, #eafff6, #d6fff0);
    color: #023;
    padding: 25px;
    border-radius: 16px;
    width: 100%;
    max-width: 350px;
    text-align: center;
  }

  .modal-content .check {
    width: 60px;
    height: 60px;
    background: #00b894;
    color: #fff;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 32px;
    margin: 0 auto 15px;
  }

  .modal-content h2 { color: #00b894; font-size: 22px; margin-bottom: 12px; }

  .modal-content .codigo {
    font-size: 28px;
    font-weight: 800;
    color: #007aff;
    letter-spacing: 2px;
    background: rgba(0,0,0,0.05);
    padding: 12px;
    border-radius: 8px;
    margin-bottom: 15px;
  }

  .modal-content .info {
    text-align: left;
    background: #fff;
    padding: 15px;
    border-radius: 10px;
    margin-bottom: 15px;
  }

  .modal-content .info p {
    display: flex;
    justify-content: space-between;
    margin: 8px 0;
    font-size: 14px;
  }

  .modal-content .info p span:first-child { color: #666; }
  .modal-content .info p span:last-child { font-weight: 600; }

  .modal-content .aviso { font-size: 13px; color: #666; margin-bottom: 15px; }

  .modal-content button {
    width: 100%;
    padding: 14px;
    border-radius: 10px;
    border: none;
    background: #00b894;
    color: #fff;
    font-size: 16px;
    font-weight: 700;
    cursor: pointer;
  }
</style>
</head>
<body>
  <div class="wrap">
    <div class="grid">
      <div class="left">
        <div class="title">Galão de Água Mineral 20L Premium</div>
        <div class="product-photo">
          <img src="https://pngimg.com/uploads/water_bottle/water_bottle_PNG9897.png" alt="Galão 20L">
        </div>
        <div class="stars">★★★★★</div>
        <div class="reviews">(247 avaliações verificadas)</div>
      </div>

      <div class="right">
        <div class="price-row">
          <div class="price">R$ 22,90</div>
        </div>

        <div class="shipping">Frete <strong style="color:#7ef5c7">GRÁTIS</strong> para Marambaia - Itaboraí RJ</div>

        <div class="payments"><strong>Formas de pagamento:</strong> Pix • Cartão de Débito • Cartão de Crédito (taxa R$ 1,00)</div>

        <div class="cart-actions">
          <div class="qty">
            <label style="font-size:13px;color:#dff9ff">Quantidade</label>
            <input id="qty" type="number" value="1" min="1" max="100" onchange="qtyChanged()">
          </div>
          <button class="btn-select" onclick="selectProduct()">Selecionar Produto</button>
        </div>

        <div id="orderSummary">
          <div class="label">Total do Pedido</div>
          <div class="total" id="totalValue">R$ 0,00</div>
          <div class="code" id="orderCode"></div>
        </div>

        <button id="payBtn" class="btn-pay" disabled onclick="openSheet()">Pagar Agora</button>

        <div class="details">
          <h3>Descrição</h3>
          <p>Água mineral natural de alta pureza, distribuída em galões lacrados e higienizados. Ideal para casa, comércio ou escritório.</p>
          <h3 style="margin-top:12px">Características</h3>
          <div class="specs">
            <p><strong>Marca:</strong> Água Pura Premium</p>
            <p><strong>Capacidade:</strong> 20 Litros</p>
            <p><strong>Tipo:</strong> Água Mineral Natural</p>
            <p><strong>Entrega:</strong> Até 40 minutos</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div id="overlay" class="overlay" onclick="fecharSheet(event)">
    <div class="sheet" onclick="event.stopPropagation()">
      <h4>Escolha a forma de pagamento</h4>

      <div class="pay-option" onclick="selectPayment('pix')">
        <div>
          <div class="label">Pix</div>
          <div class="pay-detail">Pagamento instantâneo</div>
        </div>
        <span style="font-size:20px">›</span>
      </div>

      <div class="pay-option" onclick="selectPayment('debit')">
        <div>
          <div class="label">Cartão de Débito</div>
          <div class="pay-detail">À vista</div>
        </div>
        <span style="font-size:20px">›</span>
      </div>

      <div class="pay-option" onclick="selectPayment('credit')">
        <div>
          <div class="label">Cartão de Crédito</div>
          <div class="pay-detail">Taxa R$ 1,00 aplicada</div>
        </div>
        <span style="font-size:20px">›</span>
      </div>

      <div id="paymentArea"></div>
      <button class="btn-cancelar" onclick="fecharSheet()">Cancelar</button>
    </div>
  </div>

<script>
  let productSelected = false;
  let currentPayment = null;
  const unitPrice = 22.90;
  let orderId = null;
  window.orderId = null;

  function generateOrderId() {
    return Math.floor(1000000 + Math.random() * 9000000);
  }

  function formatBRL(value) {
    return value.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
  }

  function calculateTotal(applyCreditFee = false) {
    const qty = parseInt(document.getElementById('qty').value || 1, 10);
    let total = unitPrice * qty;
    if (applyCreditFee) total += 1.00;
    return total;
  }

  function updateSummary() {
    const summary = document.getElementById('orderSummary');
    const totalText = document.getElementById('totalValue');
    const codeText = document.getElementById('orderCode');

    totalText.innerText = formatBRL(calculateTotal());
    summary.style.display = 'block';
    codeText.innerText = "Código: " + (window.orderId || '');
  }

  function selectProduct() {
    productSelected = true;
    orderId = generateOrderId();
    window.orderId = orderId;
    window.quantidadeSelecionada = parseInt(document.getElementById('qty').value || 1, 10);

    updateSummary();

    const payBtn = document.getElementById('payBtn');
    payBtn.disabled = false;
    payBtn.classList.add('active');

    alert('✅ Produto selecionado!\n\nPedido: ' + orderId + '\n\nClique em "Pagar Agora" para continuar.');
  }

  function qtyChanged() {
    window.quantidadeSelecionada = parseInt(document.getElementById('qty').value || 1, 10);
    if (productSelected) updateSummary();
  }

  function openSheet() {
    if (!productSelected) return;
    document.getElementById('overlay').style.display = 'flex';
    document.getElementById('paymentArea').innerHTML = '';
  }

  function fecharSheet(e) {
    if (e && e.target !== e.currentTarget) return;
    document.getElementById('overlay').style.display = 'none';
    document.getElementById('paymentArea').innerHTML = '';
  }

  async function handleDebitConfirm() {
    const total = calculateTotal(false);
    await finalizarCompra('debito', total);
  }

  async function handleCreditConfirm() {
    const total = calculateTotal(true);
    await finalizarCompra('credito', total);
  }

  function selectPayment(type) {
    currentPayment = type;
    const area = document.getElementById('paymentArea');
    area.innerHTML = '';

    if (type === 'pix') {
      const total = calculateTotal(false);
      area.innerHTML = `
        <div class="pix-box">
          <div>Total a pagar</div>
          <div class="valor">${formatBRL(total)}</div>
          <div style="font-size:13px;margin:8px 0">Chave Pix (CPF)</div>
          <div class="chave">202.978.417-69</div>
          <div style="font-size:12px;color:#666">Pedido: ${window.orderId}</div>
          <div class="pix-btns">
            <button class="btn-copiar" onclick="copyPix()">Copiar</button>
            <button class="btn-confirmar" onclick="finalizarCompra('pix', ${total})">Já Paguei ✓</button>
          </div>
        </div>
      `;
    } else if (type === 'debit') {
      const total = calculateTotal(false);
      area.innerHTML = `
        <div style="margin-bottom:10px;font-weight:700;color:#dff9ff;text-align:center">
          Total: ${formatBRL(total)}
        </div>
        <div class="card-form">
          <input placeholder="Número do cartão" maxlength="19">
          <input placeholder="Nome do titular">
          <div class="card-row">
            <input placeholder="MM/AA" maxlength="5">
            <input placeholder="CVC" maxlength="4">
          </div>
          <button class="btn-confirmar-pagamento" onclick="handleDebitConfirm()">Confirmar Pagamento</button>
        </div>
      `;
    } else if (type === 'credit') {
      const total = calculateTotal(true);
      area.innerHTML = `
        <div style="text-align:center;margin-bottom:10px">
          <div style="font-size:12px;color:#cfeff6">+ Taxa R$ 1,00</div>
          <div style="font-weight:700;color:#dff9ff;font-size:18px">${formatBRL(total)}</div>
        </div>
        <div class="card-form">
          <input placeholder="Número do cartão" maxlength="19">
          <input placeholder="Nome do titular">
          <div class="card-row">
            <input placeholder="MM/AA" maxlength="5">
            <input placeholder="CVC" maxlength="4">
          </div>
          <button class="btn-confirmar-pagamento" onclick="handleCreditConfirm()">Confirmar Pagamento</button>
        </div>
      `;
    }
  }

  function copyPix() {
    const key = '202.978.417-69';
    if (navigator.clipboard) {
      navigator.clipboard.writeText(key).then(() => {
        alert('✅ Chave Pix copiada!\n\n' + key + '\n\nApós pagar, clique em "Já Paguei"');
      });
    } else {
      alert('Chave Pix: ' + key);
    }
  }
</script>
</body>
</html>
