<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
<title>Comprar - √Ågua Pura Premium</title>

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;800&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<!-- ERUDA - Console para mobile -->
<script src="https://cdn.jsdelivr.net/npm/eruda"></script>
<script>eruda.init();</script>

<script>
  // ============================================
  // CONFIGURA√á√ÉO SUPABASE
  // ============================================
  const SUPABASE_URL = "https://ttqetzagmjsjiibchsqo.supabase.co";
  const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR0cWV0emFnbWpzamlpYmNoc3FvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE1MjEwNTEsImV4cCI6MjA4NzA5NzA1MX0.gwxFQHWMMeSpniFlPUKiQCx4UDWitKwx6bM22VcYArk";

  let supabase = null;
  let supabaseConectado = false;

  // Inicializa imediatamente quando o script carrega
  (function initSupabase() {
    try {
      if (typeof window.supabase === 'undefined') {
        alert('‚ùå Erro: Biblioteca Supabase n√£o carregou');
        console.error('‚ùå window.supabase n√£o existe');
        return;
      }
      
      supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
      supabaseConectado = true;
      console.log('‚úÖ Supabase inicializado com sucesso');
      alert('‚úÖ Supabase conectado!');
    } catch (error) {
      console.error('‚ùå Erro ao inicializar Supabase:', error);
      alert('‚ùå Erro Supabase: ' + error.message);
    }
  })();

  // ============================================
  // FUN√á√ïES DE PEDIDO
  // ============================================
  
  function gerarCodigoPedido() {
    return Math.floor(1000000 + Math.random() * 9000000).toString();
  }

  async function finalizarCompra(tipoPagamento, valorFinal) {
    console.log('üöÄ ========== FINALIZAR COMPRA ==========');
    console.log('Tipo:', tipoPagamento);
    console.log('Valor:', valorFinal);
    alert('üöÄ Iniciando pagamento...\nTipo: ' + tipoPagamento + '\nValor: R$ ' + valorFinal.toFixed(2));
    
    // Verifica conex√£o
    if (!supabase) {
      alert('‚ùå ERRO: Supabase n√£o inicializado');
      console.error('‚ùå supabase √© null');
      return false;
    }
    
    if (!supabaseConectado) {
      alert('‚ùå ERRO: Supabase n√£o conectado');
      console.error('‚ùå supabaseConectado √© false');
      return false;
    }

    alert('‚úÖ Supabase OK, preparando pedido...');

    // Pega dados do pedido
    const codigo = window.orderId || gerarCodigoPedido();
    const qtyInput = document.getElementById('qty');
    const qty = qtyInput ? parseInt(qtyInput.value || '1', 10) : 1;

    const pedido = {
      codigo_pedido: codigo,
      produto: "Gal√£o √Ågua Pura Premium 20L",
      quantidade: qty,
      valor_total: parseFloat(valorFinal.toFixed(2)),
      forma_pagamento: tipoPagamento,
      status: 'pendente',
      criado_em: new Date().toISOString(),
      atualizado_em: new Date().toISOString()
    };

    console.log('üì¶ Dados do pedido:', pedido);
    alert('üì¶ Pedido:\nC√≥digo: ' + codigo + '\nQtd: ' + qty + '\nTotal: R$ ' + valorFinal.toFixed(2));

    // Mostra loading
    mostrarLoading();

    try {
      console.log('üì§ Enviando para Supabase...');
      alert('üì§ Enviando para Supabase...');
      
      const { data, error } = await supabase
        .from('pedidos')
        .insert([pedido])
        .select();

      esconderLoading();

      if (error) {
        console.error('‚ùå Erro Supabase:', error);
        alert('‚ùå ERRO SUPABASE:\n' + JSON.stringify(error, null, 2));
        return false;
      }

      console.log('‚úÖ Pedido salvo:', data);
      alert('‚úÖ Pedido salvo com sucesso!\nC√≥digo: ' + codigo);
      mostrarConfirmacao(codigo, tipoPagamento, valorFinal, qty);
      return true;
      
    } catch (err) {
      esconderLoading();
      console.error('‚ùå Erro catch:', err);
      alert('‚ùå ERRO CATCH:\n' + err.message);
      return false;
    }
  }

  function mostrarLoading() {
    const div = document.createElement('div');
    div.id = 'loadingOverlay';
    div.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.8);z-index:9999;display:flex;flex-direction:column;justify-content:center;align-items:center;';
    div.innerHTML = '<div style="width:50px;height:50px;border:4px solid rgba(255,255,255,0.2);border-top-color:#00b894;border-radius:50%;animation:spin 1s linear infinite;"></div><p style="color:#fff;margin-top:15px;font-family:Poppins">Salvando pedido...</p>';
    document.body.appendChild(div);
  }

  function esconderLoading() {
    const el = document.getElementById('loadingOverlay');
    if (el) el.remove();
  }

  function mostrarConfirmacao(codigo, pagamento, valor, qtd) {
    const tipos = { 'pix': 'PIX', 'debito': 'D√©bito', 'credito': 'Cr√©dito' };
    const div = document.createElement('div');
    div.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.85);z-index:10000;display:flex;justify-content:center;align-items:center;padding:20px;';
    div.innerHTML = `
      <div style="background:linear-gradient(180deg,#eafff6,#d6fff0);color:#023;padding:25px;border-radius:16px;width:100%;max-width:350px;text-align:center;font-family:Poppins">
        <div style="width:60px;height:60px;background:#00b894;color:#fff;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:32px;margin:0 auto 15px">‚úì</div>
        <h2 style="color:#00b894;font-size:22px;margin-bottom:12px">Pedido Confirmado!</h2>
        <div style="font-size:28px;font-weight:800;color:#007aff;letter-spacing:2px;background:rgba(0,0,0,0.05);padding:12px;border-radius:8px;margin-bottom:15px">${codigo}</div>
        <div style="text-align:left;background:#fff;padding:15px;border-radius:10px;margin-bottom:15px;font-size:14px">
          <p style="display:flex;justify-content:space-between;margin:8px 0"><span style="color:#666">Produto:</span><span style="font-weight:600">Gal√£o 20L</span></p>
          <p style="display:flex;justify-content:space-between;margin:8px 0"><span style="color:#666">Qtd:</span><span style="font-weight:600">${qtd}</span></p>
          <p style="display:flex;justify-content:space-between;margin:8px 0"><span style="color:#666">Pagamento:</span><span style="font-weight:600">${tipos[pagamento]}</span></p>
          <p style="display:flex;justify-content:space-between;margin:8px 0"><span style="color:#666">Total:</span><span style="font-weight:800;color:#00b894">R$ ${valor.toFixed(2).replace('.', ',')}</span></p>
          <p style="display:flex;justify-content:space-between;margin:8px 0"><span style="color:#666">Status:</span><span style="font-weight:600;color:#f39c12">‚è≥ Pendente</span></p>
        </div>
        <p style="font-size:13px;color:#666;margin-bottom:15px">‚úÖ Pedido salvo no Supabase!</p>
        <button onclick="this.parentElement.parentElement.remove(); fecharSheet();" style="width:100%;padding:14px;border-radius:10px;border:none;background:#00b894;color:#fff;font-size:16px;font-weight:700;cursor:pointer">OK</button>
      </div>
    `;
    document.body.appendChild(div);
  }
</script>

<style>
  @keyframes spin { to { transform: rotate(360deg); } }
  
  * { box-sizing: border-box; margin: 0; padding: 0; }
  
  body {
    font-family: 'Poppins', -apple-system, sans-serif;
    background: linear-gradient(135deg, #0b2a3a, #062033);
    color: #fff;
    min-height: 100vh;
    padding: 12px;
  }

  .wrap {
    max-width: 980px;
    margin: 0 auto;
    background: rgba(255,255,255,0.03);
    border-radius: 14px;
    padding: 20px;
  }

  .grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 28px;
  }

  @media (max-width: 900px) {
    .grid { grid-template-columns: 1fr; }
  }

  .left {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 18px;
  }

  .title {
    font-size: 20px;
    font-weight: 800;
    color: #e8fbff;
    text-align: center;
  }

  .product-photo {
    width: 100%;
    max-width: 420px;
    background: rgba(255,255,255,0.03);
    border-radius: 12px;
    padding: 18px;
    display: flex;
    justify-content: center;
    align-items: center;
  }

  .product-photo img {
    width: 280px;
    max-width: 86%;
    height: auto;
    filter: drop-shadow(0 30px 60px rgba(0,0,0,0.6));
    animation: float 5s ease-in-out infinite;
  }

  @keyframes float {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-18px); }
  }

  .stars { color: #ffd166; font-weight: 700; text-align: center; font-size: 18px; }
  .reviews { font-size: 13px; color: #cfeff6; text-align: center; }

  .right { display: flex; flex-direction: column; gap: 12px; }

  .price-row { display: flex; align-items: center; gap: 14px; margin: 8px 0; }
  .price { font-size: 32px; font-weight: 900; color: #00e0ff; }
  .shipping { font-size: 14px; color: #7ef5c7; }
  .payments { font-size: 14px; color: #dff9ff; margin-top: 12px; line-height: 1.5; }

  .cart-actions {
    margin-top: 20px;
    display: flex;
    gap: 12px;
    align-items: center;
    flex-wrap: wrap;
  }

  .qty { display: flex; flex-direction: column; gap: 5px; }
  .qty label { font-size: 13px; color: #dff9ff; }

  .qty input {
    width: 80px;
    padding: 12px;
    border-radius: 10px;
    border: none;
    text-align: center;
    font-weight: 700;
    font-size: 16px;
    background: rgba(255,255,255,0.08);
    color: #fff;
  }

  .btn-select {
    padding: 14px 20px;
    border-radius: 12px;
    background: #007aff;
    color: #fff;
    border: none;
    font-weight: 700;
    font-size: 15px;
    cursor: pointer;
    transition: all 0.2s;
  }

  .btn-select:active { transform: scale(0.98); background: #0056b3; }

  .btn-pay {
    flex: 1;
    padding: 16px;
    border-radius: 12px;
    background: #6b7280;
    color: #fff;
    border: none;
    font-weight: 800;
    font-size: 16px;
    cursor: not-allowed;
    width: 100%;
    margin-top: 10px;
    transition: all 0.2s;
  }

  .btn-pay.active {
    background: #00b894;
    cursor: pointer;
  }

  .btn-pay.active:active { transform: scale(0.98); background: #00a383; }

  #orderSummary {
    margin-top: 15px;
    display: none;
    background: rgba(255,255,255,0.05);
    padding: 15px;
    border-radius: 10px;
    text-align: center;
  }

  #orderSummary .label { font-size: 13px; color: #cfeff6; }
  #orderSummary .total { font-size: 24px; font-weight: 800; color: #00e0ff; margin-top: 5px; }
  #orderSummary .code { font-size: 13px; color: #aef0ff; margin-top: 5px; }

  .details {
    margin-top: 22px;
    background: rgba(255,255,255,0.02);
    padding: 18px;
    border-radius: 12px;
  }

  .details h3 {
    margin: 0 0 10px 0;
    color: #aef0ff;
    font-size: 16px;
  }

  .details p { color: #dff9ff; font-size: 14px; line-height: 1.6; margin: 0 0 10px 0; }
  .specs p { color: #e6fbff; font-size: 14px; margin: 6px 0; }

  .overlay {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.7);
    z-index: 60;
    justify-content: center;
    align-items: flex-end;
  }

  .sheet {
    width: 100%;
    max-width: 440px;
    background: linear-gradient(180deg, #04232f, #01303a);
    color: #fff;
    border-radius: 20px 20px 0 0;
    padding: 20px;
    max-height: 90vh;
    overflow-y: auto;
    animation: slideUp 0.3s ease;
  }

  @keyframes slideUp {
    from { transform: translateY(100%); }
    to { transform: translateY(0); }
  }

  .sheet h4 { margin: 0 0 14px 0; font-size: 18px; text-align: center; }

  .pay-option {
    background: rgba(255,255,255,0.05);
    padding: 16px;
    border-radius: 12px;
    margin-bottom: 10px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    cursor: pointer;
    border: 1px solid rgba(255,255,255,0.05);
    transition: all 0.2s;
  }

  .pay-option:active { background: rgba(255,255,255,0.1); }
  .pay-option .label { font-weight: 700; color: #eaffff; font-size: 15px; }
  .pay-detail { font-size: 13px; color: #cfeff6; margin-top: 3px; }

  .pix-box {
    margin-top: 12px;
    background: linear-gradient(180deg, #eafcff, #dff8ff);
    color: #03323a;
    padding: 20px;
    border-radius: 12px;
    text-align: center;
  }

  .pix-box .valor { font-size: 24px; font-weight: 800; margin: 8px 0; }
  .pix-box .chave {
    font-size: 18px;
    font-weight: 700;
    background: rgba(0,0,0,0.1);
    padding: 12px;
    border-radius: 8px;
    margin: 12px 0;
    word-break: break-all;
  }

  .pix-btns {
    display: flex;
    gap: 10px;
    margin-top: 15px;
  }

  .pix-btns button {
    flex: 1;
    padding: 14px;
    border-radius: 10px;
    border: none;
    font-weight: 700;
    font-size: 14px;
    cursor: pointer;
    transition: all 0.2s;
  }

  .pix-btns button:active { transform: scale(0.98); }
  .btn-copiar { background: #007aff; color: #fff; }
  .btn-copiar:active { background: #0056b3; }
  .btn-confirmar { background: #00b894; color: #fff; }
  .btn-confirmar:active { background: #00a383; }

  .card-form input {
    width: 100%;
    padding: 14px;
    margin-top: 10px;
    border-radius: 10px;
    border: none;
    background: rgba(255,255,255,0.08);
    color: #fff;
    font-size: 15px;
  }

  .card-form input::placeholder { color: rgba(255,255,255,0.5); }

  .card-row { display: flex; gap: 10px; }
  .card-row input:first-child { flex: 1; }
  .card-row input:last-child { width: 100px; }

  .btn-confirmar-pagamento {
    width: 100%;
    padding: 16px;
    margin-top: 15px;
    border-radius: 10px;
    border: none;
    background: #007aff;
    color: #fff;
    font-weight: 700;
    font-size: 16px;
    cursor: pointer;
    transition: all 0.2s;
  }

  .btn-confirmar-pagamento:active { transform: scale(0.98); background: #0056b3; }

  .btn-cancelar {
    width: 100%;
    padding: 14px;
    margin-top: 10px;
    border-radius: 10px;
    border: none;
    background: transparent;
    color: #aef0ff;
    font-size: 15px;
    cursor: pointer;
  }
</style>
</head>
<body>
  <div class="wrap">
    <div class="grid">
      <div class="left">
        <div class="title">Gal√£o de √Ågua Mineral 20L Premium</div>
        <div class="product-photo">
          <img src="https://pngimg.com/uploads/water_bottle/water_bottle_PNG9897.png" alt="Gal√£o 20L">
        </div>
        <div class="stars">‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ</div>
        <div class="reviews">(247 avalia√ß√µes verificadas)</div>
      </div>

      <div class="right">
        <div class="price-row">
          <div class="price">R$ 22,90</div>
        </div>

        <div class="shipping">Frete <strong style="color:#7ef5c7">GR√ÅTIS</strong> para Marambaia - Itabora√≠ RJ</div>

        <div class="payments"><strong>Formas de pagamento:</strong> Pix ‚Ä¢ Cart√£o de D√©bito ‚Ä¢ Cart√£o de Cr√©dito (taxa R$ 1,00)</div>

        <div class="cart-actions">
          <div class="qty">
            <label>Quantidade</label>
            <input id="qty" type="number" value="1" min="1" max="100" onchange="qtyChanged()">
          </div>
          <button class="btn-select" onclick="selectProduct()">Selecionar Produto</button>
        </div>

        <div id="orderSummary">
          <div class="label">Total do Pedido</div>
          <div class="total" id="totalValue">R$ 0,00</div>
          <div class="code" id="orderCode"></div>
        </div>

        <button id="payBtn" class="btn-pay" disabled onclick="openSheet()">Pagar Agora</button>

        <div class="details">
          <h3>Descri√ß√£o</h3>
          <p>√Ågua mineral natural de alta pureza, distribu√≠da em gal√µes lacrados e higienizados. Ideal para casa, com√©rcio ou escrit√≥rio.</p>
          <h3 style="margin-top:12px">Caracter√≠sticas</h3>
          <div class="specs">
            <p><strong>Marca:</strong> √Ågua Pura Premium</p>
            <p><strong>Capacidade:</strong> 20 Litros</p>
            <p><strong>Tipo:</strong> √Ågua Mineral Natural</p>
            <p><strong>Entrega:</strong> At√© 40 minutos</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div id="overlay" class="overlay" onclick="fecharSheet(event)">
    <div class="sheet" onclick="event.stopPropagation()">
      <h4>Escolha a forma de pagamento</h4>

      <div class="pay-option" onclick="selectPayment('pix')">
        <div>
          <div class="label">üí† Pix</div>
          <div class="pay-detail">Pagamento instant√¢neo</div>
        </div>
        <span style="font-size:24px;color:#aef0ff">‚Ä∫</span>
      </div>

      <div class="pay-option" onclick="selectPayment('debit')">
        <div>
          <div class="label">üí≥ D√©bito</div>
          <div class="pay-detail">√Ä vista</div>
        </div>
        <span style="font-size:24px;color:#aef0ff">‚Ä∫</span>
      </div>

      <div class="pay-option" onclick="selectPayment('credit')">
        <div>
          <div class="label">üí≥ Cr√©dito</div>
          <div class="pay-detail">Taxa R$ 1,00 aplicada</div>
        </div>
        <span style="font-size:24px;color:#aef0ff">‚Ä∫</span>
      </div>

      <div id="paymentArea"></div>
      <button class="btn-cancelar" onclick="fecharSheet()">Cancelar</button>
    </div>
  </div>

<script>
  // ============================================
  // VARI√ÅVEIS GLOBAIS
  // ============================================
  let productSelected = false;
  let currentPayment = null;
  const unitPrice = 22.90;
  let orderId = null;
  window.orderId = null;

  // ============================================
  // FUN√á√ïES AUXILIARES
  // ============================================
  function generateOrderId() {
    return Math.floor(1000000 + Math.random() * 9000000);
  }

  function formatBRL(value) {
    return value.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
  }

  function calculateTotal(applyCreditFee = false) {
    const qty = parseInt(document.getElementById('qty').value || '1', 10);
    let total = unitPrice * qty;
    if (applyCreditFee) total += 1.00;
    return total;
  }

  function updateSummary() {
    const summary = document.getElementById('orderSummary');
    const totalText = document.getElementById('totalValue');
    const codeText = document.getElementById('orderCode');

    totalText.innerText = formatBRL(calculateTotal());
    summary.style.display = 'block';
    codeText.innerText = "C√≥digo: " + (window.orderId || '');
  }

  // ============================================
  // FUN√á√ïES DE INTERA√á√ÉO
  // ============================================
  function selectProduct() {
    productSelected = true;
    orderId = generateOrderId();
    window.orderId = orderId;

    updateSummary();

    const payBtn = document.getElementById('payBtn');
    payBtn.disabled = false;
    payBtn.classList.add('active');

    alert('‚úÖ Produto selecionado!\n\nC√≥digo do pedido: ' + orderId + '\n\nClique em "Pagar Agora" para continuar.');
  }

  function qtyChanged() {
    if (productSelected) updateSummary();
  }

  function openSheet() {
    if (!productSelected) {
      alert('Selecione o produto primeiro!');
      return;
    }
    document.getElementById('overlay').style.display = 'flex';
    document.getElementById('paymentArea').innerHTML = '';
  }

  function fecharSheet(e) {
    if (e && e.target !== e.currentTarget) return;
    document.getElementById('overlay').style.display = 'none';
    document.getElementById('paymentArea').innerHTML = '';
  }

  // ============================================
  // HANDLERS DE PAGAMENTO
  // ============================================
  async function handleDebitConfirm() {
    const total = calculateTotal(false);
    await finalizarCompra('debito', total);
  }

  async function handleCreditConfirm() {
    const total = calculateTotal(true);
    await finalizarCompra('credito', total);
  }

  function selectPayment(type) {
    currentPayment = type;
    const area = document.getElementById('paymentArea');
    area.innerHTML = '';

    if (type === 'pix') {
      const total = calculateTotal(false);
      area.innerHTML = `
        <div class="pix-box">
          <div style="font-size:13px;color:#666">Total a pagar</div>
          <div class="valor">${formatBRL(total)}</div>
          <div style="font-size:13px;color:#666;margin:10px 0 5px">Chave Pix (CPF)</div>
          <div class="chave">202.978.417-69</div>
          <div style="font-size:12px;color:#888;margin-top:8px">Pedido: ${window.orderId}</div>
          <div class="pix-btns">
            <button class="btn-copiar" onclick="copyPix()">üìã Copiar</button>
            <button class="btn-confirmar" onclick="finalizarCompra('pix', ${total})">‚úì J√° Paguei</button>
          </div>
        </div>
      `;
    } else if (type === 'debit') {
      const total = calculateTotal(false);
      area.innerHTML = `
        <div style="margin-bottom:12px;font-weight:700;color:#dff9ff;text-align:center;font-size:18px">
          ${formatBRL(total)}
        </div>
        <div class="card-form">
          <input type="text" placeholder="N√∫mero do cart√£o" maxlength="19">
          <input type="text" placeholder="Nome do titular">
          <div class="card-row">
            <input type="text" placeholder="MM/AA" maxlength="5">
            <input type="text" placeholder="CVC" maxlength="4">
          </div>
          <button class="btn-confirmar-pagamento" onclick="handleDebitConfirm()">Confirmar Pagamento</button>
        </div>
      `;
    } else if (type === 'credit') {
      const total = calculateTotal(true);
      area.innerHTML = `
        <div style="text-align:center;margin-bottom:12px">
          <div style="font-size:12px;color:#cfeff6">+ Taxa R$ 1,00</div>
          <div style="font-weight:700;color:#dff9ff;font-size:20px;margin-top:5px">${formatBRL(total)}</div>
        </div>
        <div class="card-form">
          <input type="text" placeholder="N√∫mero do cart√£o" maxlength="19">
          <input type="text" placeholder="Nome do titular">
          <div class="card-row">
            <input type="text" placeholder="MM/AA" maxlength="5">
            <input type="text" placeholder="CVC" maxlength="4">
          </div>
          <button class="btn-confirmar-pagamento" onclick="handleCreditConfirm()">Confirmar Pagamento</button>
        </div>
      `;
    }
  }

  function copyPix() {
    const key = '202.978.417-69';
    if (navigator.clipboard && navigator.clipboard.writeText) {
      navigator.clipboard.writeText(key).then(() => {
        alert('‚úÖ Chave Pix copiada!\n\n' + key + '\n\nAp√≥s pagar, clique em "J√° Paguei ‚úì"');
      }).catch(() => {
        alert('Chave Pix:\n' + key);
      });
    } else {
      alert('Chave Pix:\n' + key);
    }
  }

  // Inicializa o total
  updateSummary();
</script>
</body>
</html>
