<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Criar Conta - √Ågua Pura Premium</title>

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;800&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
body{background: linear-gradient(135deg,#0a192f,#001f3f,#003f5c);color:white;font-family:'Poppins',sans-serif;padding:40px 20px;display:flex;justify-content:center;align-items:center;min-height:100vh;}
.container{background: rgba(255,255,255,0.05);backdrop-filter: blur(15px);padding:40px 30px;border-radius:20px;width:100%;max-width:500px;box-shadow:0 0 40px rgba(0,234,255,0.2);}
h2{text-align:center;margin-bottom:30px;font-weight:800;background: linear-gradient(90deg,#ffffff,#00eaff);-webkit-background-clip:text;-webkit-text-fill-color:transparent;}
.input-group{margin-bottom:18px;}
label{font-size:13px;margin-bottom:5px;display:block;}
input, select{width:100%;padding:12px;border:none;border-radius:10px;outline:none;font-size:14px;background:white;color:#333;}
.tipo-residencia{display:flex;gap:10px;margin-top:5px;}
.tipo-btn{flex:1;padding:12px;border:2px solid rgba(255,255,255,0.2);border-radius:10px;background:transparent;color:white;cursor:pointer;transition:all 0.3s;font-size:13px;}
.tipo-btn:hover{border-color:#00eaff;}
.tipo-btn.selecionado{border-color:#00eaff;background:rgba(0,234,255,0.2);}
button{width:100%;padding:14px;border:none;border-radius:30px;background:white;color:#003f5c;font-weight:600;cursor:pointer;transition:0.3s;margin-top:10px;}
button:hover{background:#00eaff;color:white;transform:scale(1.05);}
.extra{margin-top:20px;text-align:center;font-size:13px;}
.extra a{color:#00eaff;text-decoration:none;}
.erro{color:#ff6b6b;font-size:12px;margin-top:5px;display:none;}
</style>
</head>

<body>
<div class="container">
<h2>Criar Conta</h2>

<!-- NOME -->
<div class="input-group">
<label>Nome *</label>
<input type="text" id="nome" placeholder="Digite seu nome">
</div>

<!-- SOBRENOME -->
<div class="input-group">
<label>Sobrenome *</label>
<input type="text" id="sobrenome" placeholder="Digite seu sobrenome">
</div>

<!-- EMAIL -->
<div class="input-group">
<label>Email *</label>
<input type="email" id="email" placeholder="Digite seu email">
</div>

<!-- CPF -->
<div class="input-group">
<label>CPF *</label>
<input type="text" id="cpf" placeholder="000.000.000-00" maxlength="14">
</div>

<!-- RUA -->
<div class="input-group">
<label>Rua *</label>
<input type="text" id="rua" placeholder="Nome da rua/avenida">
</div>

<!-- N√öMERO -->
<div class="input-group">
<label>N√∫mero da Casa/Apto *</label>
<input type="text" id="numero" placeholder="Ex: 123 ou Apto 45">
</div>

<!-- BAIRRO -->
<div class="input-group">
<label>Bairro *</label>
<input type="text" id="bairro" placeholder="Seu bairro">
</div>

<!-- TIPO DE RESID√äNCIA -->
<div class="input-group">
<label>Tipo de Resid√™ncia *</label>
<div class="tipo-residencia">
<button type="button" class="tipo-btn" onclick="selecionarTipo('casa', this)">üè† Casa</button>
<button type="button" class="tipo-btn" onclick="selecionarTipo('condominio', this)">üè¢ Condom√≠nio</button>
<button type="button" class="tipo-btn" onclick="selecionarTipo('predio', this)">üè¨ Pr√©dio</button>
</div>
<input type="hidden" id="tipoResidencia">
</div>

<!-- COMPLEMENTO (OPCIONAL) -->
<div class="input-group">
<label>Complemento <small style="color:#aaa;">(opcional)</small></label>
<input type="text" id="complemento" placeholder="Bloco, andar, refer√™ncia...">
</div>

<!-- SENHA -->
<div class="input-group">
<label>Senha *</label>
<input type="password" id="senha" placeholder="Crie uma senha (m√≠n. 6 caracteres)">
</div>

<button type="button" onclick="cadastrar()">Criar Conta</button>

<div class="extra">
J√° tem conta? <a href="login.html">Entrar</a>
</div>
</div>

<script>
// SUPABASE
const supabaseUrl = "https://ttqetzagmjsjiibchsqo.supabase.co";
const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR0cWV0emFnbWpzamlpYmNoc3FvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE1MjEwNTEsImV4cCI6MjA4NzA5NzA1MX0.gwxFQHWMMeSpniFlPUKiQCx4UDWitKwx6bM22VcYArk";
const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

// M√°scara CPF
document.getElementById('cpf').addEventListener('input', function(e) {
  var v = e.target.value.replace(/\D/g, '');
  v = v.replace(/(\d{3})(\d)/, '$1.$2');
  v = v.replace(/(\d{3})(\d)/, '$1.$2');
  v = v.replace(/(\d{3})(\d{1,2})$/, '$1-$2');
  e.target.value = v;
});

// Selecionar tipo de resid√™ncia
function selecionarTipo(tipo, btn) {
  document.querySelectorAll('.tipo-btn').forEach(function(b) {
    b.classList.remove('selecionado');
  });
  btn.classList.add('selecionado');
  document.getElementById('tipoResidencia').value = tipo;
}

// Cadastrar
async function cadastrar() {
  // Pega valores
  const nome = document.getElementById("nome").value.trim();
  const sobrenome = document.getElementById("sobrenome").value.trim();
  const email = document.getElementById("email").value.trim().toLowerCase();
  const cpf = document.getElementById("cpf").value.trim();
  const rua = document.getElementById("rua").value.trim();
  const numero = document.getElementById("numero").value.trim();
  const bairro = document.getElementById("bairro").value.trim();
  const tipoResidencia = document.getElementById("tipoResidencia").value;
  const complemento = document.getElementById("complemento").value.trim();
  const senha = document.getElementById("senha").value;

  // Valida√ß√µes
  if (!nome) { alert("Digite seu nome!"); document.getElementById("nome").focus(); return; }
  if (!sobrenome) { alert("Digite seu sobrenome!"); document.getElementById("sobrenome").focus(); return; }
  if (!email) { alert("Digite seu email!"); document.getElementById("email").focus(); return; }
  if (!cpf || cpf.length < 14) { alert("Digite um CPF v√°lido!"); document.getElementById("cpf").focus(); return; }
  if (!rua) { alert("Digite a rua!"); document.getElementById("rua").focus(); return; }
  if (!numero) { alert("Digite o n√∫mero!"); document.getElementById("numero").focus(); return; }
  if (!bairro) { alert("Digite o bairro!"); document.getElementById("bairro").focus(); return; }
  if (!tipoResidencia) { alert("Selecione o tipo de resid√™ncia!"); return; }
  if (!senha || senha.length < 6) { alert("A senha deve ter no m√≠nimo 6 caracteres!"); document.getElementById("senha").focus(); return; }

  try {
    // 1. Cria cliente
    const { data: clienteData, error: clienteError } = await supabase
      .from('clientes')
      .insert([{
        nome: nome,
        sobrenome: sobrenome,
        email: email,
        cpf: cpf,
        rua: rua,
        numero_casa: numero,
        bairro: bairro,
        tipo_residencia: tipoResidencia,
        complemento: complemento || null
      }])
      .select();

    if (clienteError) {
      if (clienteError.message.includes('unique') || clienteError.message.includes('duplicate')) {
        alert("‚ùå CPF ou Email j√° cadastrado!");
      } else {
        alert("Erro ao cadastrar: " + clienteError.message);
      }
      return;
    }

    const clienteId = clienteData[0].id;

    // 2. Cria usu√°rio
    const { error: usuarioError } = await supabase
      .from('usuarios')
      .insert([{
        email: email,
        senha: senha,
        cliente_id: clienteId
      }]);

    if (usuarioError) {
      alert("Erro ao criar login: " + usuarioError.message);
      return;
    }

    // 3. Salva dados no localStorage para usar na compra
    localStorage.setItem('clienteLogado', JSON.stringify({
      id: clienteId,
      nome: nome,
      email: email,
      endereco: rua + ', ' + numero + ' - ' + bairro
    }));

    // 4. Redireciona para compra
    alert("‚úÖ Cadastro realizado com sucesso!");
    window.location.href = "comprar.html";

  } catch (err) {
    alert("Erro inesperado: " + err.message);
    console.error(err);
  }
}
</script>
</body>
</html>
